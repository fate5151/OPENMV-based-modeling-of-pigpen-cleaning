# UV激光绘图系统 - 使用说明

## 概述

本系统实现了基于OpenMV的UV激光绘图功能，包含高精度激光点检测、自适应PID控制和智能回退机制。系统解决了激光点检测失效、颜色阈值不准确、缺少检测质量评估等关键问题。

## 核心功能

### 1. 激光点检测模块 (laser_detection.py)

**主要特性：**
- 多级检测策略：HSV + RGB双重颜色空间检测
- 智能形状验证：圆形度、长宽比、面积约束
- 检测质量评估：置信度计算和历史一致性分析
- 智能回退机制：基于历史位置的预测和平滑估算

**核心函数：**
```python
get_current_laser_position(img, debug=False)
```
- 返回激光点位置、置信度、检测方法等详细信息
- 自动处理检测失效情况，提供多级回退策略

### 2. 激光控制模块 (laser_control.py)

**主要特性：**
- 自适应PID控制：根据检测置信度和误差大小自动调整PID参数
- 三级控制策略：保守、基础、激进PID参数组合
- 舵机保护：角度限制、速度限制、状态监控
- 控制历史记录：用于系统诊断和性能优化

**核心函数：**
```python
control_laser(detection_result, debug=False)
```
- 基于检测结果进行精确的激光位置控制
- 自动选择最适合的PID控制器

### 3. 主系统模块 (uv_laser_drawing.py)

**主要特性：**
- 完整的用户界面：按键控制、状态显示、实时调试
- 绘图功能：支持预定义路径绘制（如正方形）
- 系统监控：FPS监控、统计报告、性能分析
- 容错设计：异常处理、自动恢复、状态保护

## 技术要点

### 1. 蓝紫色激光检测优化

**HSV颜色空间阈值：**
```python
laser_thresholds = [
    (220, 255, 30, 100, 30, 100),  # 蓝色范围
    (240, 280, 30, 100, 30, 100),  # 紫色范围
    (200, 240, 20, 80, 20, 80),    # 更宽泛的蓝色
]
```

**形状约束：**
- 最小面积：5像素
- 最大面积：500像素
- 最小圆形度：0.3
- 最大长宽比：3.0

### 2. 自适应PID控制策略

**控制器选择逻辑：**
- 高置信度(>0.8) + 大误差(>50px) → 激进控制器
- 高置信度(>0.8) + 小误差 → 基础控制器
- 中等置信度(0.4-0.8) → 基础控制器
- 低置信度(<0.4) → 保守控制器

**PID参数：**
```python
# 基础参数
base_pid = PID(p=0.05, i=0.001, d=0.01, imax=50)

# 保守参数
conservative_pid = PID(p=0.02, i=0.0005, d=0.005, imax=30)

# 激进参数
aggressive_pid = PID(p=0.08, i=0.002, d=0.02, imax=80)
```

### 3. 检测失效时的回退策略

**多级回退机制：**
1. **预测策略**：基于最近两个位置的线性预测
2. **平均策略**：使用历史位置的加权平均
3. **完全失效**：返回None，触发系统保护

## 使用指南

### 1. 系统启动

```python
from uv_laser_drawing import UVLaserDrawingSystem

# 创建系统实例
system = UVLaserDrawingSystem()

# 启动系统
system.run()
```

### 2. 按键控制

| 按键 | 功能 | 说明 |
|------|------|------|
| P7 | 系统开/关 | 激活/停用整个系统 |
| P8 | 调试模式 | 开启/关闭详细调试信息 |
| P9 | 重置系统 | 清除历史记录，重置PID |
| P4 | 设置目标 | 将目标位置设为图像中心 |
| P3 | 舵机归零 | 将舵机角度重置为0° |
| P5 | 自动模式 | 开启/关闭自动目标跟踪 |
| P7+P8 | 开始绘图 | 启动/停止预定义路径绘图 |
| P9+P4 | 系统统计 | 打印详细的性能统计 |

### 3. 调试和测试

**基础检测测试：**
```python
from test_laser_detection import interactive_test
interactive_test()
```

**性能评估：**
```python
# 在主系统中按P9+P4查看统计信息
system._print_system_stats()
```

## 配置调整

### 1. 检测阈值调整

```python
# 运行时动态调整
detector.adjust_thresholds(threshold_index=0, param_index=0, delta=10)

# 参数索引说明：
# 0: H_min, 1: H_max, 2: S_min, 3: S_max, 4: V_min, 5: V_max
```

### 2. PID参数调整

```python
# 调整特定控制器的参数
controller.adjust_pid_params(
    controller_type="base",  # "base", "conservative", "aggressive"
    param_type="p",          # "p", "i", "d"
    delta=0.01               # 调整量
)
```

### 3. 控制参数调整

```python
# 修改置信度阈值
controller.confidence_threshold_high = 0.8
controller.confidence_threshold_low = 0.4

# 修改舵机限制
controller.max_servo_angle = 90
controller.servo_speed_limit = 10
```

## 性能监控

### 1. 检测性能指标

- **成功率**：成功检测激光点的比例
- **HSV/RGB检测比例**：不同检测方法的使用情况
- **形状过滤数量**：被形状约束过滤的检测数
- **置信度分布**：检测结果的置信度统计

### 2. 控制性能指标

- **控制成功率**：成功执行控制指令的比例
- **平均误差**：位置控制的平均误差
- **自适应调整次数**：PID参数自动调整的频率
- **舵机限制触发**：达到舵机角度限制的次数

### 3. 系统监控

```python
# 实时监控
print(f"FPS: {system.fps_timer.fps():.1f}")
print(f"检测率: {detector.get_detection_stats()['success_rate']:.1f}%")
print(f"控制成功率: {controller.get_control_stats()['success_rate']:.1f}%")
```

## 故障排除

### 1. 检测失效

**现象：**激光点无法检测或检测不稳定

**解决方案：**
1. 检查激光颜色是否为蓝紫色
2. 调整HSV阈值参数
3. 确保激光点大小在约束范围内
4. 检查环境光照条件

### 2. 控制振荡

**现象：**激光点在目标位置附近震荡

**解决方案：**
1. 切换到保守PID参数
2. 降低P参数，增加D参数
3. 检查舵机机械阻尼
4. 确保检测置信度足够高

### 3. 系统延迟

**现象：**激光跟踪反应缓慢

**解决方案：**
1. 检查图像处理FPS
2. 优化检测算法参数
3. 减少调试信息输出
4. 检查硬件性能

## 扩展功能

### 1. 自定义绘图路径

```python
# 定义自定义路径
custom_path = [
    (100, 100), (200, 100), (200, 200), (100, 200)
]
system.drawing_path = custom_path
```

### 2. 多激光点检测

```python
# 扩展检测器支持多个激光点
# (需要修改laser_detection.py)
```

### 3. 网络控制接口

```python
# 添加UDP/TCP控制接口
# (需要添加网络通信模块)
```

## 技术规格

- **支持分辨率**：320x240 (QVGA)
- **检测精度**：±2像素
- **控制频率**：≥20Hz
- **响应时间**：<100ms
- **角度范围**：±90°
- **位置精度**：±5像素

## 版本历史

- **v1.0**：基础激光检测和控制功能
- **v1.1**：添加自适应PID控制
- **v1.2**：优化检测算法，添加回退机制
- **v1.3**：完善用户界面和调试功能

---

**开发者注意事项：**
1. 所有角度单位为度
2. 坐标系原点在图像左上角
3. HSV颜色空间：H(0-360), S(0-100), V(0-100)
4. 系统默认假设激光点为圆形或近似圆形